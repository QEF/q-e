#!/bin/sh

# run from directory where this script is
cd `echo $0 | sed 's/\(.*\)\/.*/\1/'` # extract pathname
EXAMPLE_DIR=`pwd`

# check whether echo has the -e option
if test "`echo -e`" = "-e" ; then ECHO=echo ; else ECHO="echo -e" ; fi

$ECHO
$ECHO "$EXAMPLE_DIR : starting"
$ECHO
$ECHO
# set the needed environment variables
. ../../../environment_variables

# required executables and pseudopotentials
BIN_LIST="pioud.x"

$ECHO
$ECHO "  executables directory: $BIN_DIR"
$ECHO "  pseudo directory:      $PSEUDO_DIR"
$ECHO "  temporary directory:   $TMP_DIR"
$ECHO "  checking that needed directories and files exist...\c"

# check for directories
for DIR in "$BIN_DIR" "$PSEUDO_DIR" ; do
    if test ! -d $DIR ; then
        $ECHO
        $ECHO "ERROR: $DIR not existent or not a directory"
        $ECHO "Aborting"
        exit 1
    fi
done
for DIR in "$TMP_DIR" "$EXAMPLE_DIR/results" ; do
    if test ! -d $DIR ; then
        mkdir $DIR
    fi
done
cd $EXAMPLE_DIR/results

# check for executables
for FILE in $BIN_LIST ; do
    if test ! -x $BIN_DIR/$FILE ; then
        $ECHO
        $ECHO "ERROR: $BIN_DIR/$FILE not existent or not executable"
        $ECHO "Aborting"
        exit 1
    fi
done

# how to run executables
PIOUD_COMMAND="$PARA_PREFIX $BIN_DIR/pioud.x $PARA_POSTFIX"
$ECHO
$ECHO "  running Born-Oppenheimer PIOUD as: $PIOUD_COMMAND"
$ECHO

# clean TMP_DIR
$ECHO "  cleaning $TMP_DIR...\c"
rm -rf $TMP_DIR/pwscf*
$ECHO " done"

nbeadMD=30

# NEB calculation. Automatic choice of the climbing image.
cat > hy666.in << EOF
BEGIN
BEGIN_PIMD_INPUT
&dynamics
  restart_pimd=.false.
  nbeadMD=$nbeadMD
  nunitcells=27
  nblocks=6
  nstep_block=5000
  iprint=2
  irun=4
  delt=0.9605819  !! for pioud, 41.32231 which is 1 fs in a.u., must be divided for sqrt(m_1)
  tempMD=300.d0
  gammaMD=0.0628062d0
  sigmacov=0.0d0
  delta_force=1.d-4
  delta_harm=5.d-3
  delta0=0.0d0
  delta0k=1.0d0
  delta0q=0.0d0
  yessecond=.true.
  yesturboq=.true.
/
END_PIMD_INPUT
BEGIN_PATH_INPUT
&PATH
  restart_mode      = 'from_scratch'
  string_method     = 'neb',
  nstep_path        = 20,
  ds                = 2.D0,
  opt_scheme        = "broyden",
  num_of_images     = $nbeadMD,
  k_max             = 0.3D0,
  k_min             = 0.2D0,
  CI_scheme         = "auto",
  path_thr          = 0.1D0,
/
END_PATH_INPUT
BEGIN_ENGINE_INPUT
&CONTROL
  prefix         = "hydrogen"
  outdir         = "$TMP_DIR",
  pseudo_dir     = "$PSEUDO_DIR",
/
&SYSTEM
    ibrav = 7 ,
    nosym_evc= .true.
    a=3.6043723636,
    c=9.27414741644,
    nat = 54,
    ntyp = 1,
    nspin=1,
    ecutwfc = 45.0,
    ecutrho = 400.0,
    smearing='gaussian',
    occupations='smearing',
    degauss=0.005,
/
&ELECTRONS
    diagonalization='david',
    conv_thr = 1.d-8,
    mixing_mode = 'plain',
    mixing_beta = 0.3,
    electron_maxstep = 200
/
&IONS
/
ATOMIC_SPECIES
H    1.00784  H.pz-rrkjus.UPF
BEGIN_POSITIONS
FIRST_IMAGE
ATOMIC_POSITIONS angstrom
H    -0.0565083367447321  -0.1133301464460553  1.6442445172905735
H    0.0533720562916913  -0.4422699455338565  2.1552958526102528
H    -0.4699537565409879  -0.6332913245863909  3.0350065031081361
H    -0.7170215010362814  -0.8862595282014083  3.9117524096640746
H    -1.0747435226918158  -1.2678233834765482  4.5381351798731995
H    -1.2537746625990209  -1.6589556536249810  5.4359996884898649
H    0.6294427738802213  0.6068671588742436  2.9984697289369207
H    0.6015589308377323  -0.1614195999872594  4.0991791357545724
H    -0.0446310045889001  -0.1325843955768055  4.9066138290590722
H    0.1035371379331720  -0.5356429464401407  5.5434238492289323
H    -0.4989435303049778  -0.8241035427032970  6.1059223361097077
H    -0.6192472017042200  -1.3892268037195572  6.9120943985693000
H    1.5180264153565781  1.4912472265997807  4.5131595233171833
H    1.0704443920907694  0.5831290234236978  5.3573295015056113
H    0.6011304805521029  0.6279692756866203  6.1245927371296842
H    0.7237680276059884  -0.0870924724915094  7.0123643583927073
H    0.0753116324596772  -0.1162232768276767  7.5644357895160628
H    -0.0649394812772341  -0.5910210006719840  8.4022600222147439
H    0.5490711945632165  -0.5872647779834659  3.0550630146475313
H    0.6759221834429004  -1.2395507609044809  3.7812544014121316
H    -0.1052322291783963  -1.1295193786346351  4.5270457459456361
H    -0.2072232209474933  -1.8881341550622079  5.3731966161914935
H    -0.5684860791635753  -1.9279526635165289  6.1844347413949192
H    -0.5296873423617999  -2.2709590608793975  6.8723522091459337
H    1.1638976036125068  0.1605224428383326  4.7662258326120330
H    1.4425564038418286  -0.7104094330170490  5.5225376128365795
H    0.5941626549956565  -0.6428083440423041  6.2212643327688149
H    0.6038850057685388  -1.4221329829917488  7.0587068950416709
H    0.0651989562327979  -1.3542355928649616  7.8178742718982575
H    0.0090803686650519  -1.8511764088223692  8.6659943903038492
H    1.8071958540601256  0.4536312238806944  6.2254129029766396
H    1.7621957433618662  0.0011421315374684  6.9023072291002094
H    1.1775936809619554  0.0624066190725148  7.6489089821002292
H    1.1392003631179171  -0.3439364718427325  8.5666946073232442
H    0.5897620201659114  -0.6176550314677486  9.2258538311239917
H    0.5382723759481700  -1.0696813769104900  10.2376056543568996
H    1.1444609552734797  -1.2052478553043720  4.5732344006965313
H    1.1614208576790608  -1.7303588023811105  5.3246660926205225
H    0.6809071332179484  -1.7913274980958842  6.3295032175525519
H    0.6116758156559602  -2.5773599949748469  6.9161874774722794
H    -0.0341437745910128  -2.1661788995151823  7.8634261264297942
H    0.1776783540432424  -2.9369525445296931  8.4351295046478239
H    1.5959856646563879  -0.5891463502376364  6.0934629328794276
H    1.8057064651552246  -1.2160145082421705  7.0231116088318046
H    1.3020140334716370  -1.2736036244759203  7.7142364755827355
H    1.1817105744519836  -1.7436187918210264  8.5410787721397980
H    0.5394345347618094  -1.7364880213819092  9.3867701490187496
H    0.6018668849161413  -2.2119270557398392  9.8595641406918926
H    2.2624143546861921  -0.0051849398587817  7.6938775623164881
H    2.3252150195998609  -0.7460860335093364  8.5114301632655298
H    1.6543081626923102  -0.6092774891777920  9.2159040693826846
H    1.7577603314779200  -1.0595827565592262  10.0661034058089154
H    1.2238583109705390  -1.3023985870541304  10.7612178215783825
H    1.1629282585261023  -1.8505658733438466  11.5142542919476902
LAST_IMAGE
ATOMIC_POSITIONS angstrom
H    -0.0565083367447321  -0.1133301464460553  1.6442445172905735
H    0.0533720562916913  -0.4422699455338565  2.1552958526102528
H    -0.4699537565409879  -0.6332913245863909  3.0350065031081361
H    -0.7170215010362814  -0.8862595282014083  3.9117524096640746
H    -1.0747435226918158  -1.2678233834765482  4.5381351798731995
H    -1.2537746625990209  -1.6589556536249810  5.4359996884898649
H    0.6294427738802213  0.6068671588742436  2.9984697289369207
H    0.6015589308377323  -0.1614195999872594  4.0991791357545724
H    -0.0446310045889001  -0.1325843955768055  4.9066138290590722
H    0.1035371379331720  -0.5356429464401407  5.5434238492289323
H    -0.4989435303049778  -0.8241035427032970  6.1059223361097077
H    -0.6192472017042200  -1.3892268037195572  6.9120943985693000
H    1.5180264153565781  1.4912472265997807  4.5131595233171833
H    1.0704443920907694  0.5831290234236978  5.3573295015056113
H    0.6011304805521029  0.6279692756866203  6.1245927371296842
H    0.7237680276059884  -0.0870924724915094  7.0123643583927073
H    0.0753116324596772  -0.1162232768276767  7.5644357895160628
H    -0.0649394812772341  -0.5910210006719840  8.4022600222147439
H    0.5490711945632165  -0.5872647779834659  3.0550630146475313
H    0.6759221834429004  -1.2395507609044809  3.7812544014121316
H    -0.1052322291783963  -1.1295193786346351  4.5270457459456361
H    -0.2072232209474933  -1.8881341550622079  5.3731966161914935
H    -0.5684860791635753  -1.9279526635165289  6.1844347413949192
H    -0.5296873423617999  -2.2709590608793975  6.8723522091459337
H    1.1638976036125068  0.1605224428383326  4.7662258326120330
H    1.4425564038418286  -0.7104094330170490  5.5225376128365795
H    0.5941626549956565  -0.6428083440423041  6.2212643327688149
H    0.6038850057685388  -1.4221329829917488  7.0587068950416709
H    0.0651989562327979  -1.3542355928649616  7.8178742718982575
H    0.0090803686650519  -1.8511764088223692  8.6659943903038492
H    1.8071958540601256  0.4536312238806944  6.2254129029766396
H    1.7621957433618662  0.0011421315374684  6.9023072291002094
H    1.1775936809619554  0.0624066190725148  7.6489089821002292
H    1.1392003631179171  -0.3439364718427325  8.5666946073232442
H    0.5897620201659114  -0.6176550314677486  9.2258538311239917
H    0.5382723759481700  -1.0696813769104900  10.2376056543568996
H    1.1444609552734797  -1.2052478553043720  4.5732344006965313
H    1.1614208576790608  -1.7303588023811105  5.3246660926205225
H    0.6809071332179484  -1.7913274980958842  6.3295032175525519
H    0.6116758156559602  -2.5773599949748469  6.9161874774722794
H    -0.0341437745910128  -2.1661788995151823  7.8634261264297942
H    0.1776783540432424  -2.9369525445296931  8.4351295046478239
H    1.5959856646563879  -0.5891463502376364  6.0934629328794276
H    1.8057064651552246  -1.2160145082421705  7.0231116088318046
H    1.3020140334716370  -1.2736036244759203  7.7142364755827355
H    1.1817105744519836  -1.7436187918210264  8.5410787721397980
H    0.5394345347618094  -1.7364880213819092  9.3867701490187496
H    0.6018668849161413  -2.2119270557398392  9.8595641406918926
H    2.2624143546861921  -0.0051849398587817  7.6938775623164881
H    2.3252150195998609  -0.7460860335093364  8.5114301632655298
H    1.6543081626923102  -0.6092774891777920  9.2159040693826846
H    1.7577603314779200  -1.0595827565592262  10.0661034058089154
H    1.2238583109705390  -1.3023985870541304  10.7612178215783825
H    1.1629282585261023  -1.8505658733438466  11.5142542919476902
END_POSITIONS
K_POINTS automatic
6 6 6 0 0 0
END_ENGINE_INPUT
END
EOF

$ECHO "  running Born-Oppenheimer pioud calculation... "
$PIOUD_COMMAND -inp hy666.in  > hy666.out
check_failure $?
$ECHO " done"

# clean TMP_DIR
#$ECHO "  cleaning $TMP_DIR...\c"
#rm -rf $TMP_DIR/pwscf*
#$ECHO " done"
