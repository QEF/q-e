#!/bin/sh

# run from directory where this script is
cd `echo $0 | sed 's/\(.*\)\/.*/\1/'` # extract pathname
EXAMPLE_DIR=`pwd`

# check whether echo has the -e option
if test "`echo -e`" = "-e" ; then ECHO=echo ; else ECHO="echo -e" ; fi

$ECHO
$ECHO "$EXAMPLE_DIR : starting"
$ECHO
$ECHO
# set the needed environment variables
. ../../../environment_variables

# required executables and pseudopotentials
BIN_LIST="pioud.x"

$ECHO
$ECHO "  executables directory: $BIN_DIR"
$ECHO "  pseudo directory:      $PSEUDO_DIR"
$ECHO "  temporary directory:   $TMP_DIR"
$ECHO "  checking that needed directories and files exist...\c"

# check for directories
for DIR in "$BIN_DIR" "$PSEUDO_DIR" ; do
    if test ! -d $DIR ; then
        $ECHO
        $ECHO "ERROR: $DIR not existent or not a directory"
        $ECHO "Aborting"
        exit 1
    fi
done
for DIR in "$TMP_DIR" "$EXAMPLE_DIR/results" ; do
    if test ! -d $DIR ; then
        mkdir $DIR
    fi
done
cd $EXAMPLE_DIR/results

# check for executables
for FILE in $BIN_LIST ; do
    if test ! -x $BIN_DIR/$FILE ; then
        $ECHO
        $ECHO "ERROR: $BIN_DIR/$FILE not existent or not executable"
        $ECHO "Aborting"
        exit 1
    fi
done

# how to run executables
PIOUD_COMMAND="$PARA_PREFIX $BIN_DIR/pioud.x $PARA_POSTFIX"
$ECHO
$ECHO "  running Born-Oppenheimer PIOUD as: $PIOUD_COMMAND"
$ECHO

# clean TMP_DIR
$ECHO "  cleaning $TMP_DIR...\c"
rm -rf $TMP_DIR/pwscf*
$ECHO " done"

nbeadMD=50

# NEB calculation. Automatic choice of the climbing image.
cat > hy333.in << EOF
BEGIN
BEGIN_PIMD_INPUT
&dynamics
  restart_pimd=.false.
  nbeadMD=$nbeadMD
  nunitcells=64
  nblocks=6
  nstep_block=5000
  iprint=2
  irun=4
  delt=0.9605819  !! for pioud, 41.32231 which is 1 fs in a.u., must be divided for sqrt(m_1)
  tempMD=80.d0
  gammaMD=0.0628062d0
  sigmacov=0.0d0
  delta_force=1.d-4
  delta_harm=5.d-3
  delta0=0.0d0
  delta0k=1.0d0
  delta0q=0.0d0
  yessecond=.true.
  yesturboq=.true.
/
END_PIMD_INPUT
BEGIN_PATH_INPUT
&PATH
  restart_mode      = 'from_scratch'
  string_method     = 'neb',
  nstep_path        = 20,
  ds                = 2.D0,
  opt_scheme        = "broyden",
  num_of_images     = $nbeadMD,
  k_max             = 0.3D0,
  k_min             = 0.2D0,
  CI_scheme         = "auto",
  path_thr          = 0.1D0,
/
END_PATH_INPUT
BEGIN_ENGINE_INPUT
&CONTROL
  prefix         = "hydro128"
  outdir         = "$TMP_DIR",
  pseudo_dir     = "$PSEUDO_DIR",
/
&SYSTEM
    ibrav = 7 ,
    nosym_evc = .true.
    a = 4.84,
    c = 12.32,
    nat = 128,
    ntyp = 1,
    nspin=1,
    ecutwfc = 45.0,
    ecutrho = 270.0,
    smearing='gaussian',
    occupations='smearing',
    degauss=0.01,
    nbnd=82
/
&ELECTRONS
    diagonalization='david',
    conv_thr = 1.d-8,
    mixing_mode = 'plain',
    mixing_beta = 0.3,
    electron_maxstep = 200
/
&IONS
/
ATOMIC_SPECIES
H    1.00784  H.pbe-rrkjus_psl.1.0.0.UPF
BEGIN_POSITIONS
FIRST_IMAGE
ATOMIC_POSITIONS angstrom
H -0.605 0.605 -4.6199999
H 0.0 0.605 -3.85
H -1.2100001 0.0 -3.0799999
H -0.605 0.0 -2.31
H -1.8150001 -0.605 -1.54
H -1.2100001 -0.605 -0.77
H -2.4200001 -1.2100001 0.0
H -1.8150001 -1.2100001 0.77
H 0.0 1.2100001 -3.0799999
H 0.605 1.2100001 -2.31
H -0.605 0.605 -1.54
H 0.0 0.605 -0.77
H -1.2100001 0.0 0.0
H -0.605 0.0 0.77
H -1.8150001 -0.605 1.54
H -1.2100001 -0.605 2.31
H 0.605 1.8150001 -1.54
H 1.2100001 1.8150001 -0.77
H 0.0 1.2100001 0.0
H 0.605 1.2100001 0.77
H -0.605 0.605 1.54
H 0.0 0.605 2.31
H -1.2100001 0.0 3.0799999
H -0.605 0.0 3.85
H 1.2100001 2.4200001 0.0
H 1.8150001 2.4200001 0.77
H 0.605 1.8150001 1.54
H 1.2100001 1.8150001 2.31
H 0.0 1.2100001 3.0799999
H 0.605 1.2100001 3.85
H -0.605 0.605 4.6199999
H 0.0 0.605 5.3899999
H 0.0 0.0 -3.0799999
H 0.605 0.0 -2.31
H -0.605 -0.605 -1.54
H 0.0 -0.605 -0.77
H -1.2100001 -1.2100001 0.0
H -0.605 -1.2100001 0.77
H -1.8150001 -1.8150001 1.54
H -1.2100001 -1.8150001 2.31
H 0.605 0.605 -1.54
H 1.2100001 0.605 -0.77
H 0.0 0.0 0.0
H 0.605 0.0 0.77
H -0.605 -0.605 1.54
H 0.0 -0.605 2.31
H -1.2100001 -1.2100001 3.0799999
H -0.605 -1.2100001 3.85
H 1.2100001 1.2100001 0.0
H 1.8150001 1.2100001 0.77
H 0.605 0.605 1.54
H 1.2100001 0.605 2.31
H 0.0 0.0 3.0799999
H 0.605 0.0 3.85
H -0.605 -0.605 4.6199999
H 0.0 -0.605 5.3899999
H 1.8150001 1.8150001 1.54
H 2.4200001 1.8150001 2.31
H 1.2100001 1.2100001 3.0799999
H 1.8150001 1.2100001 3.85
H 0.605 0.605 4.6199999
H 1.2100001 0.605 5.3899999
H 0.0 0.0 6.1599999
H 0.605 0.0 6.9299998
H 0.605 -0.605 -1.54
H 1.2100001 -0.605 -0.77
H 0.0 -1.2100001 0.0
H 0.605 -1.2100001 0.77
H -0.605 -1.8150001 1.54
H 0.0 -1.8150001 2.31
H -1.2100001 -2.4200001 3.0799999
H -0.605 -2.4200001 3.85
H 1.2100001 0.0 0.0
H 1.8150001 0.0 0.77
H 0.605 -0.605 1.54
H 1.2100001 -0.605 2.31
H 0.0 -1.2100001 3.0799999
H 0.605 -1.2100001 3.85
H -0.605 -1.8150001 4.6199999
H 0.0 -1.8150001 5.3899999
H 1.8150001 0.605 1.54
H 2.4200001 0.605 2.31
H 1.2100001 0.0 3.0799999
H 1.8150001 0.0 3.85
H 0.605 -0.605 4.6199999
H 1.2100001 -0.605 5.3899999
H 0.0 -1.2100001 6.1599999
H 0.605 -1.2100001 6.9299998
H 2.4200001 1.2100001 3.0799999
H 3.0250001 1.2100001 3.85
H 1.8150001 0.605 4.6199999
H 2.4200001 0.605 5.3899999
H 1.2100001 0.0 6.1599999
H 1.8150001 0.0 6.9299998
H 0.605 -0.605 7.6999998
H 1.2100001 -0.605 8.4699993
H 1.2100001 -1.2100001 0.0
H 1.8150001 -1.2100001 0.77
H 0.605 -1.8150001 1.54
H 1.2100001 -1.8150001 2.31
H 0.0 -2.4200001 3.0799999
H 0.605 -2.4200001 3.85
H -0.605 -3.0250001 4.6199999
H 0.0 -3.0250001 5.3899999
H 1.8150001 -0.605 1.54
H 2.4200001 -0.605 2.31
H 1.2100001 -1.2100001 3.0799999
H 1.8150001 -1.2100001 3.85
H 0.605 -1.8150001 4.6199999
H 1.2100001 -1.8150001 5.3899999
H 0.0 -2.4200001 6.1599999
H 0.605 -2.4200001 6.9299998
H 2.4200001 0.0 3.0799999
H 3.0250001 0.0 3.85
H 1.8150001 -0.605 4.6199999
H 2.4200001 -0.605 5.3899999
H 1.2100001 -1.2100001 6.1599999
H 1.8150001 -1.2100001 6.9299998
H 0.605 -1.8150001 7.6999998
H 1.2100001 -1.8150001 8.4699993
H 3.0250001 0.605 4.6199999
H 3.6300001 0.605 5.3899999
H 2.4200001 0.0 6.1599999
H 3.0250001 0.0 6.9299998
H 1.8150001 -0.605 7.6999998
H 2.4200001 -0.605 8.4699993
H 1.2100001 -1.2100001 9.2399998
H 1.8150001 -1.2100001 10.0100002
LAST_IMAGE
ATOMIC_POSITIONS angstrom
H -0.605 0.605 -4.6199999
H 0.0 0.605 -3.85
H -1.2100001 0.0 -3.0799999
H -0.605 0.0 -2.31
H -1.8150001 -0.605 -1.54
H -1.2100001 -0.605 -0.77
H -2.4200001 -1.2100001 0.0
H -1.8150001 -1.2100001 0.77
H 0.0 1.2100001 -3.0799999
H 0.605 1.2100001 -2.31
H -0.605 0.605 -1.54
H 0.0 0.605 -0.77
H -1.2100001 0.0 0.0
H -0.605 0.0 0.77
H -1.8150001 -0.605 1.54
H -1.2100001 -0.605 2.31
H 0.605 1.8150001 -1.54
H 1.2100001 1.8150001 -0.77
H 0.0 1.2100001 0.0
H 0.605 1.2100001 0.77
H -0.605 0.605 1.54
H 0.0 0.605 2.31
H -1.2100001 0.0 3.0799999
H -0.605 0.0 3.85
H 1.2100001 2.4200001 0.0
H 1.8150001 2.4200001 0.77
H 0.605 1.8150001 1.54
H 1.2100001 1.8150001 2.31
H 0.0 1.2100001 3.0799999
H 0.605 1.2100001 3.85
H -0.605 0.605 4.6199999
H 0.0 0.605 5.3899999
H 0.0 0.0 -3.0799999
H 0.605 0.0 -2.31
H -0.605 -0.605 -1.54
H 0.0 -0.605 -0.77
H -1.2100001 -1.2100001 0.0
H -0.605 -1.2100001 0.77
H -1.8150001 -1.8150001 1.54
H -1.2100001 -1.8150001 2.31
H 0.605 0.605 -1.54
H 1.2100001 0.605 -0.77
H 0.0 0.0 0.0
H 0.605 0.0 0.77
H -0.605 -0.605 1.54
H 0.0 -0.605 2.31
H -1.2100001 -1.2100001 3.0799999
H -0.605 -1.2100001 3.85
H 1.2100001 1.2100001 0.0
H 1.8150001 1.2100001 0.77
H 0.605 0.605 1.54
H 1.2100001 0.605 2.31
H 0.0 0.0 3.0799999
H 0.605 0.0 3.85
H -0.605 -0.605 4.6199999
H 0.0 -0.605 5.3899999
H 1.8150001 1.8150001 1.54
H 2.4200001 1.8150001 2.31
H 1.2100001 1.2100001 3.0799999
H 1.8150001 1.2100001 3.85
H 0.605 0.605 4.6199999
H 1.2100001 0.605 5.3899999
H 0.0 0.0 6.1599999
H 0.605 0.0 6.9299998
H 0.605 -0.605 -1.54
H 1.2100001 -0.605 -0.77
H 0.0 -1.2100001 0.0
H 0.605 -1.2100001 0.77
H -0.605 -1.8150001 1.54
H 0.0 -1.8150001 2.31
H -1.2100001 -2.4200001 3.0799999
H -0.605 -2.4200001 3.85
H 1.2100001 0.0 0.0
H 1.8150001 0.0 0.77
H 0.605 -0.605 1.54
H 1.2100001 -0.605 2.31
H 0.0 -1.2100001 3.0799999
H 0.605 -1.2100001 3.85
H -0.605 -1.8150001 4.6199999
H 0.0 -1.8150001 5.3899999
H 1.8150001 0.605 1.54
H 2.4200001 0.605 2.31
H 1.2100001 0.0 3.0799999
H 1.8150001 0.0 3.85
H 0.605 -0.605 4.6199999
H 1.2100001 -0.605 5.3899999
H 0.0 -1.2100001 6.1599999
H 0.605 -1.2100001 6.9299998
H 2.4200001 1.2100001 3.0799999
H 3.0250001 1.2100001 3.85
H 1.8150001 0.605 4.6199999
H 2.4200001 0.605 5.3899999
H 1.2100001 0.0 6.1599999
H 1.8150001 0.0 6.9299998
H 0.605 -0.605 7.6999998
H 1.2100001 -0.605 8.4699993
H 1.2100001 -1.2100001 0.0
H 1.8150001 -1.2100001 0.77
H 0.605 -1.8150001 1.54
H 1.2100001 -1.8150001 2.31
H 0.0 -2.4200001 3.0799999
H 0.605 -2.4200001 3.85
H -0.605 -3.0250001 4.6199999
H 0.0 -3.0250001 5.3899999
H 1.8150001 -0.605 1.54
H 2.4200001 -0.605 2.31
H 1.2100001 -1.2100001 3.0799999
H 1.8150001 -1.2100001 3.85
H 0.605 -1.8150001 4.6199999
H 1.2100001 -1.8150001 5.3899999
H 0.0 -2.4200001 6.1599999
H 0.605 -2.4200001 6.9299998
H 2.4200001 0.0 3.0799999
H 3.0250001 0.0 3.85
H 1.8150001 -0.605 4.6199999
H 2.4200001 -0.605 5.3899999
H 1.2100001 -1.2100001 6.1599999
H 1.8150001 -1.2100001 6.9299998
H 0.605 -1.8150001 7.6999998
H 1.2100001 -1.8150001 8.4699993
H 3.0250001 0.605 4.6199999
H 3.6300001 0.605 5.3899999
H 2.4200001 0.0 6.1599999
H 3.0250001 0.0 6.9299998
H 1.8150001 -0.605 7.6999998
H 2.4200001 -0.605 8.4699993
H 1.2100001 -1.2100001 9.2399998
H 1.8150001 -1.2100001 10.0100002
END_POSITIONS
K_POINTS automatic
3 3 3 0 0 0
END_ENGINE_INPUT
END
EOF

$ECHO "  running Born-Oppenheimer pioud calculation... "
$PIOUD_COMMAND -inp hy333.in  > hy333.out
check_failure $?
$ECHO " done"

# clean TMP_DIR
#$ECHO "  cleaning $TMP_DIR...\c"
#rm -rf $TMP_DIR/pwscf*
#$ECHO " done"
